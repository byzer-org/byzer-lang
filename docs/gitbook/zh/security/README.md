# 保障数据安全

【文档更新日志：2020-04-10】

> Note: 本文档适用于MLSQL Engine 1.3.0 及以上版本。  
> 对应的Spark版本可支持2.3.2/2.4.3

MLSQL的权限内置于语言级别。这意味着，通过MLSQL我们就可以控制各种数据源的访问，亦或是MLSQL
自身的各种功能。

> MLSQL将一切资源都抽象成了表，最细粒度可以控制到列级别。

基本逻辑为：

1. MLSQL Engine在解析MLSQL语法时，可以获取所有表。
2. MLSQL Engine在执行时具体语句时，可以获取相关表的字段信息。
3. 解析后，真实执行语句前，MLSQL会将所有的发送给【权限服务器】，权限服务器返回校验结果。
4. 如果此时权限校验通过，在执行每一个语句时，会将单独的信息在上报给【权限服务器】，【权限服务器】返回校验结果。

在静态解析时，就已经能进行权限校验，这是MLSQL一个很大的优势，这意味着用户在很短的时间内就知道自己的
语句能不能被授权执行，而不是执行了大半天以后才突然告诉你，你有某张表没有被授权。

在上面的文字中，我们多了一个【权限服务器】的角色。MLSQL允许用户自定义开发一个client 完成和【权限服务器】的交互。当然了，  
系统默认提供了一个client，但是这样就需要权限服务器复合该默认client的要求。通过自定义client,  
MLSQL 可以很好的集成到任何权限控制系统中。

在MLSQL Stack里，MLSQL Console同时也实现了粒度到表的权限控制，这意味着MLSQL Console
是一个web console的同时，也是一个权限服务器。他可以作为一个实现参考。我们会在后面的内容具体阐述如何
开发MLSQL的权限体系。

下面用一个图更好的描述：

原理可以用如下流程来解释：

```
mlsql脚本 MLSQL-Console  ------->  MLSQL-Engine
                                   ^   |
                               |     解析MLSQL
                            |           |
                                脚本中所有表信息,当前用户
                          |             |
                       |            权限中心client -------------> 权限中心
                    |                   |                            |
                    <---授权结果 ------权限中心client    <----------- |

```

基本描述就是：

1. MLSQL Engine接脚本，检查是否开启授权验证
2. 如果开启，则解析该脚本所有表，然后获取表相关信息如数据源类型，表名，操作类型（create/save等）
3. 检查用户配置的client实现，调用其代码
4. 用户client需要连接自己的授权中心，查看执行脚本的用户是否对这些表有相应的权限啊
5. 返回权限验证结果。
6. 失败，则MLSQL Engine会拒绝执行该脚本。
7. 成功，则MLSQL Engine会继续执行该脚本。