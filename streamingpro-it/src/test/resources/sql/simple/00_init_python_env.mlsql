--%comparator=tech.mlsql.it.IgnoreResultComparator
-- !plugin app add - "mlsql-shell-2.4";

!sh script '''!/bin/bash
#############################################
## Supported environment:
##   - macOs (Darwin Kernel)
##   - Ubuntu (Linux Kernel)
#############################################

# Install conda environment
echo "Start to install conda..."
_UNAME_OUT="$(uname -s)"
case "${_UNAME_OUT}" in
    Linux*)     _MACHINE=Linux;;
    Darwin*)    _MACHINE=Mac;;
    CYGWIN*)    _MACHINE=Cygwin;;
    MINGW*)     _MACHINE=MinGw;;
    *)          _MACHINE="UNKNOWN:${_UNAME_OUT}"
esac
echo ${_MACHINE}
if [ ! -x "$(command -v conda)" ];then
    if [ -x /opt/conda/etc/profile.d/conda.sh ];then
        . /opt/conda/etc/profile.d/conda.sh
        if [ ! -x "$(command -v conda)" ];then
            echo "installation failed! The /opt/conda directory already exists, but command of conda cannot be used. Please try to repair or delete path /opt/conda and try again."
            exit 1
        fi
    fi
    _MINICONDA3_DOWNLOAD_URL=""
    if [ "${_MACHINE}" == "Mac" ];then
        _MINICONDA3_DOWNLOAD_URL="https://repo.anaconda.com/miniconda/Miniconda3-latest-MacOSX-x86_64.sh"
        # miniconda requires bzip2
        if [ ! -x "$(command -v bzip2)" ];then
            if [ ! -x "$(command -v brew)" ];then
                echo "" && \
                echo "Please install homebrew to your macOs first. You can run the following commands:" && \
                echo "" && \
                echo '      /usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"' && \
                echo "" && \
                exit 1
            brew install bzip2
        fi
    elif [ "${_MACHINE}" == "Linux" ];then
        _MINICONDA3_DOWNLOAD_URL="https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh"
        # miniconda requires bzip2
        if [ ! -x "$(command -v bzip2)" ];then
            apt-get update
            apt-get install bzip2
        fi
    else
        echo "Windows  is not supported yet"
        exit 0
    fi
    wget --quiet ${_MINICONDA3_DOWNLOAD_URL} -O ~/miniconda.sh && \
        /bin/bash ~/miniconda.sh -b -p /opt/conda && \
    rm ~/miniconda.sh && \
        /opt/conda/bin/conda clean -tipsy && \
        ln -s /opt/conda/etc/profile.d/conda.sh /etc/profile.d/conda.sh && \
    echo '
# conda environment
. /opt/conda/etc/profile.d/conda.sh
. /opt/conda/bin/activate
export PATH="/opt/conda/bin:$PATH"' >> ~/.bashrc && \
        . ~/.bashrc
        if [ $? != 0 ];then
            echo "installation failed, please check the environment!"
            exit 1
        fi
    echo "Conda initialization is complete!"
else
    echo "Conda environment already exists!"
fi

# Add official channels
conda config --add channels conda-forge && \
conda config --add channels defaults && \
conda config --add channels r  && \
conda config --add channels bioconda

# Add tsinghua channels
conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/  && \
conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main/  && \
conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/conda-forge/  && \
conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/msys2/  && \
conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/bioconda/  && \
conda config --set show_channel_urls yes

# Check if it is installed
if test -z "$(conda env list |grep it_env)";then
    echo "Start to create a conda environment with python version 3.6.7: it_env..."   && \
    conda create --name it_env python=3.6.7  && \
    echo "The conda environment is created."
else
    echo "Conda environment already exists."
fi

. /opt/conda/bin/activate it_env && \
echo "Start to install pip dependencies..." && \
pip install --upgrade pip  && \
pip config set global.trusted-host  mirrors.aliyun.com && \
pip config set global.index-url http://mirrors.aliyun.com/pypi/simple/ && \
pip install --upgrade Cython pytest-runner pyarrow==5.0.0 ray==1.3.0 \
aiohttp psutil grpcio pandas xlsxwriter watchdog requests click uuid sfcli \
pyjava vega_datasets plotly aioredis==1.3.1
echo "Conda environment initialization is complete!"
''';